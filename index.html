let isAutoMode = false;
let nextUrl = "";
let targetTabId = null;
let autoTimer = null;

// 1. ì´ˆê¸° ì„¤ì • ë° ë³µêµ¬
chrome.storage.local.get(['geminiKey', 'savedContent'], (res) => {
    if(res.geminiKey) document.getElementById('apiKey').value = res.geminiKey;
    if(res.savedContent) {
        document.getElementById('content').innerHTML = res.savedContent;
        setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
        updateStatus("ğŸ’¾ ì´ì „ ì‘ì—… ë‚´ìš© ë³µêµ¬ë¨");
    }
});

document.getElementById('apiKey').addEventListener('change', (e) => {
    chrome.storage.local.set({ geminiKey: e.target.value.trim() });
});

// UI ì´ë²¤íŠ¸ ì—°ê²°
document.getElementById('btnHelp').addEventListener('click', () => document.getElementById('help-modal').style.display = 'block');
document.getElementById('btnCloseHelp').addEventListener('click', () => document.getElementById('help-modal').style.display = 'none');
document.getElementById('btnFetch').addEventListener('click', () => fetchCurrentPage(false));

document.getElementById('btnAuto').addEventListener('click', () => {
    document.getElementById('manual-prompt').style.display = 'none';
    isAutoMode = !isAutoMode;
    const btn = document.getElementById('btnAuto');

    if(isAutoMode) {
        btn.innerText = "ğŸ›‘ ìë™ ì£¼í–‰ ì¤‘ì§€";
        fetchCurrentPage(true);
    } else {
        stopAutoMode("â›” ì‚¬ìš©ìê°€ ì •ì§€í•¨");
    }
});

document.getElementById('btnResume').addEventListener('click', () => {
    document.getElementById('manual-prompt').style.display = 'none';
    isAutoMode = true;
    document.getElementById('btnAuto').innerText = "ğŸ›‘ ìë™ ì£¼í–‰ ì¤‘ì§€";
    fetchCurrentPage(true); 
});

document.getElementById('btnSave').addEventListener('click', saveToFile);
document.getElementById('btnPdf').addEventListener('click', saveToPDF); // PDF ê¸°ëŠ¥ ìœ ì§€
document.getElementById('btnClear').addEventListener('click', () => {
    if(confirm("ëª¨ë“  ë²ˆì—­ ë‚´ìš©ì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        document.getElementById('content').innerHTML = "";
        chrome.storage.local.remove('savedContent');
        updateStatus("ğŸ—‘ï¸ ì´ˆê¸°í™” ì™„ë£Œ");
    }
});

function stopAutoMode(msg = "ğŸ›‘ ìë™ ì£¼í–‰ ì¤‘ì§€") {
    isAutoMode = false;
    if(autoTimer) clearTimeout(autoTimer);
    document.getElementById('btnAuto').innerText = "ğŸš€ ìë™ ì£¼í–‰ (Auto)";
    updateStatus(msg);
}

// ìœ í‹¸ë¦¬í‹°
function splitText(text, size = 3500) {
    const chunks = [];
    for (let i = 0; i < text.length; i += size) {
        chunks.push(text.substring(i, i + size));
    }
    return chunks;
}
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

async function getBestModel(key) {
    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
        const data = await res.json();
        const validModels = data.models?.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
        if (!validModels || validModels.length === 0) return "gemini-pro";

        let best = validModels.find(m => m.name.includes("gemini-1.5-flash"));
        if (!best) best = validModels.find(m => m.name.includes("gemini-1.5-pro"));
        if (!best) best = validModels.find(m => m.name.includes("gemini-pro"));
        
        return best ? best.name.replace("models/", "") : "gemini-1.5-flash";
    } catch (e) { return "gemini-1.5-flash"; }
}

// ------------------------------------------------------------------
// ë©”ì¸ ë¡œì§
// ------------------------------------------------------------------
async function fetchCurrentPage(auto, retryCount = 0) {
    if (auto && !isAutoMode) return;
    const key = document.getElementById('apiKey').value.trim();
    if(!key) return alert("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

    updateStatus("Step 1/4: ğŸ“¡ ì›ë¬¸ í˜ì´ì§€ ì ‘ì† ì¤‘...");

    try {
        if (!targetTabId) {
            const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
            targetTabId = tab.id;
        }

        try { await chrome.tabs.get(targetTabId); } 
        catch { throw new Error("ì†Œì„¤ íƒ­ì´ ë‹«í˜”ìŠµë‹ˆë‹¤."); }

        // 1ì°¨ í…ìŠ¤íŠ¸ í™•ë³´
        let response = await chrome.tabs.sendMessage(targetTabId, { action: "GET_TEXT" });
        if(!response) throw new Error("ì‘ë‹µ ì—†ìŒ. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.");

        // [í•µì‹¬ ê¸°ëŠ¥] í˜ì´ì§€ ë¡œë”© ì•ˆì •í™” ì²´í¬ (ëœ ëœ¬ í˜ì´ì§€ ë°©ì§€)
        if (auto) {
            let attempts = 0;
            while (attempts < 3) { // ìµœëŒ€ 3íšŒ(ì•½ 3ì´ˆ) ì¶”ê°€ í™•ì¸
                await wait(1000); // 1ì´ˆ ëŒ€ê¸°
                const checkRes = await chrome.tabs.sendMessage(targetTabId, { action: "GET_TEXT" });
                
                // 1ì´ˆ ì „ë³´ë‹¤ ë‚´ìš©ì´ 50ì ì´ìƒ ëŠ˜ì–´ë‚¬ë‹¤ë©´? -> ì•„ì§ ë¡œë”© ì¤‘ì¸ ê²ƒì„!
                if (checkRes.text.length > response.text.length + 50) {
                    updateStatus(`â³ ì¶”ê°€ ë‚´ìš© ë¡œë”© ì¤‘... (${response.text.length} -> ${checkRes.text.length}ì)`);
                    response = checkRes; // ë” ê¸´ ë‚´ìš©ìœ¼ë¡œ ê°±ì‹ 
                    attempts = 0; // ë¡œë”© ì¤‘ì´ë©´ ì¹´ìš´íŠ¸ ë¦¬ì…‹í•˜ê³  ë” ê¸°ë‹¤ë¦¼
                } else {
                    break; // ë‚´ìš© ë³€í™” ì—†ìœ¼ë©´ ë¡œë”© ëë‚œ ê²ƒìœ¼ë¡œ ê°„ì£¼
                }
                attempts++;
            }
        }

        updateStatus(`Step 2/4: âœ… ì›ë¬¸ í™•ë³´ ì™„ë£Œ (${response.title.substring(0, 10)}... / ${response.text.length}ì)`);
        
        // í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨(ë¬´í•œ ë¡œë”©) ê°ì§€
        const lastTitle = document.querySelector('.episode-box:last-child .ep-title');
        if (auto && lastTitle && lastTitle.innerText === response.title) {
            if (retryCount >= 5) { // 5íšŒ ì¬ì‹œë„ í›„ì—ë„ ì œëª©ì´ ê°™ìœ¼ë©´
                updateStatus("âš ï¸ í˜ì´ì§€ ì´ë™ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.");
                document.getElementById('manual-prompt').style.display = 'block';
                stopAutoMode("âš ï¸ ì´ë™ ì‹¤íŒ¨ë¡œ ì •ì§€");
                return; 
            }
            updateStatus(`â³ í˜ì´ì§€ ì´ë™ ëŒ€ê¸° ì¤‘... (${retryCount + 1}/5)`);
            await wait(2000);
            if(!isAutoMode) return;
            return fetchCurrentPage(true, retryCount + 1); 
        }

        nextUrl = response.nextUrl; 

        updateStatus("Step 3/4: ğŸ¤– ë²ˆì—­ ëª¨ë¸ ì—°ê²° ì¤‘...");
        const modelName = await getBestModel(key);
        if(auto && !isAutoMode) return;

        await processTranslation(key, response.text, response.title, auto, modelName);

    } catch(e) {
        updateStatus("âš ï¸ " + e.message);
        stopAutoMode("âš ï¸ ì˜¤ë¥˜ë¡œ ì¸í•œ ì •ì§€");
    }
}

async function processTranslation(key, fullText, title, auto, modelName) {
    if(auto && !isAutoMode) return;

    const contentDiv = document.getElementById('content');
    if(contentDiv.innerText.includes("ì™¼ìª½ì˜ ì†Œì„¤")) contentDiv.innerHTML = "";

    const box = document.createElement("div");
    box.className = "episode-box";
    const titleDiv = document.createElement("div");
    titleDiv.className = "ep-title";
    titleDiv.innerText = title;
    box.appendChild(titleDiv);
    contentDiv.appendChild(box);

    const chunks = splitText(fullText, 3500);
    
    updateStatus(`Step 4/4: âš¡ ë²ˆì—­ ì‹œì‘ (ì´ ${chunks.length}êµ¬ê°„)`);

    for (let i = 0; i < chunks.length; i++) {
        if (auto && !isAutoMode) {
            updateStatus("â›” ë²ˆì—­ ì¤‘ë‹¨ë¨");
            return;
        }

        const percent = Math.round(((i) / chunks.length) * 100);
        updateStatus(`Step 4/4: â³ ë²ˆì—­ ì¤‘... ${percent}% ì™„ë£Œ (${i+1}/${chunks.length} êµ¬ê°„)`);
        
        const loader = document.createElement("div");
        loader.className = "loading";
        loader.innerHTML = `<b>${percent}%</b> ì§„í–‰ ì¤‘...<br><span style="font-size:0.8em">(${i+1}/${chunks.length} êµ¬ê°„)</span>`;
        box.appendChild(loader);
        
        window.scrollTo(0, document.body.scrollHeight);

        try {
            const translatedText = await callGeminiApi(key, chunks[i], modelName);
            loader.remove();
            const p = document.createElement("div");
            p.innerHTML = translatedText.replace(/\n/g, '<br>');
            box.appendChild(p);

            chrome.storage.local.set({ savedContent: contentDiv.innerHTML }); // ì‹¤ì‹œê°„ ì €ì¥

        } catch (e) {
            loader.innerHTML = `âŒ ì˜¤ë¥˜: ${e.message}`;
            loader.style.color = "red";
            stopAutoMode("âš ï¸ ë²ˆì—­ ì‹¤íŒ¨ë¡œ ì •ì§€");
            return; 
        }
    }

    updateStatus("âœ… ë²ˆì—­ 100% ì™„ë£Œ!");
    chrome.storage.local.set({ savedContent: contentDiv.innerHTML });
    
    await wait(1000);
    window.scrollTo(0, document.body.scrollHeight);

    if(auto) {
        if(!isAutoMode) return;
        if(nextUrl) {
            updateStatus("ğŸš€ 3ì´ˆ í›„ ë‹¤ìŒ í™”ë¡œ ì´ë™...");
            autoTimer = setTimeout(async () => {
                if(!isAutoMode) return; 
                await chrome.tabs.update(targetTabId, { url: nextUrl });
                updateStatus("ğŸ“„ ìƒˆ í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°...");
                autoTimer = setTimeout(() => fetchCurrentPage(true), 5000); 
            }, 3000);
        } else {
            updateStatus("âš ï¸ ë‹¤ìŒ í™” ë²„íŠ¼ ì—†ìŒ");
            document.getElementById('manual-prompt').style.display = 'block';
            stopAutoMode("âš ï¸ ë§í¬ ì—†ìŒ");
        }
    }
}

async function callGeminiApi(key, text, modelName) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent`;
    const response = await fetch(url, {
        method: "POST", 
        headers: { "Content-Type": "application/json", "x-goog-api-key": key },
        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: 
            `ë‹¹ì‹ ì€ ì†Œì„¤ ë²ˆì—­ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ì´ì–´ì§€ëŠ” ë‚´ìš©ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”. ì£¼ì„ ê¸ˆì§€.\n\n${text}` 
        }] }] })
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.error?.message || "API ì˜¤ë¥˜");
    return data.candidates[0].content.parts[0].text;
}

// ------------------------------------------------------------------
// ì €ì¥ ë° PDF ì¶œë ¥ ê¸°ëŠ¥
// ------------------------------------------------------------------
function saveToFile() {
    const content = document.getElementById('content').innerHTML;
    if(!content || content.includes("ì™¼ìª½ì˜ ì†Œì„¤")) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
    
    const date = new Date().toISOString().slice(0, 10);
    const htmlContent = `
        <!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ë²ˆì—­ ì†Œì„¤</title>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
        <style>
            body { max-width: 800px; margin: 0 auto; padding: 40px; font-family: 'Noto Serif KR', serif; line-height: 2.0; font-size: 18px; background: #fdfbf7; color: #333; }
            .ep-title { font-size: 1.6em; font-weight: bold; border-bottom: 2px solid #555; margin-top: 60px; margin-bottom: 30px; }
            .loading { display: none; }
        </style></head><body>${content}</body></html>`;

    const blob = new Blob([htmlContent], {type: "text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `Novel_Translation_${date}.html`;
    a.click();
}

function saveToPDF() {
    const content = document.getElementById('content').innerHTML;
    if(!content || content.includes("ì™¼ìª½ì˜ ì†Œì„¤")) return alert("ë‚´ìš© ì—†ìŒ");
    const printWindow = window.open('', '', 'width=900,height=800');
    printWindow.document.write(`
        <!DOCTYPE html><html lang="ko"><head><title>PDF ì €ì¥</title>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
        <style>
            @page { margin: 20mm; }
            body { font-family: 'Noto Serif KR', serif; line-height: 1.8; font-size: 14pt; }
            .ep-title { font-size: 1.8em; font-weight: bold; border-bottom: 2px solid #000; margin-top: 50px; margin-bottom: 30px; page-break-after: avoid; }
            .loading { display: none; }
        </style></head><body>${content}</body></html>`);
    printWindow.document.close();
    printWindow.onload = function() { printWindow.focus(); printWindow.print(); };
}

function updateStatus(msg) {
    document.getElementById('status').innerText = msg;
}
