<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Smart Tab Reader</title>
    <style>
        :root { --bg: #f5f5f7; --paper: #fff; --text: #333; --primary: #007aff; --danger: #ff3b30; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* ì¸ì‡„/PDF ì €ì¥ìš© ìŠ¤íƒ€ì¼ */
        @media print {
            @page { size: A4; margin: 20mm; }
            body { background: white; height: auto; display: block; overflow: visible; }
            header, #setupBox, #progressBarContainer, ::-webkit-scrollbar { display: none !important; }
            #readerContainer { padding: 0; display: block; overflow: visible; height: auto; }
            #paper { box-shadow: none; width: 100%; max-width: 100%; padding: 0; margin: 0; border: none; min-height: 0; }
            .novel-text { font-size: 11pt; line-height: 1.8; color: black; text-align: justify; }
            .episode-title { page-break-before: always; margin-top: 0 !important; padding-top: 50px; }
            
            /* ì™„ë£Œ êµ¬ë¶„ì„ : PDFì—ì„œëŠ” ì ì„ ë§Œ ë‚¨ê¹€ */
            .episode-end { 
                color: transparent !important; 
                font-size: 0 !important;       
                border-top: 1px dashed #ccc !important; 
                margin: 50px 0 !important; 
                padding: 0 !important;
                height: 1px;
            }
        }

        header { 
            flex-shrink: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 12px 20px; border-bottom: 1px solid #ddd; 
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap; z-index: 1000;
        }
        .brand { font-weight: 800; font-size: 1.2rem; margin-right: 10px; color: #1d1d1f; }
        
        input, select { padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px; font-size: 13px; outline: none; }
        input:focus { border-color: var(--primary); }
        #apiKeyInput { width: 120px; }
        #modelSelect { width: 160px; background: #f2f2f7; color: #007aff; font-weight: 600; }
        #urlInput { flex-grow: 1; min-width: 150px; }

        button { padding: 8px 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; background: var(--primary); font-size: 13px; transition: 0.2s; white-space: nowrap; }
        button:hover { opacity: 0.9; }
        
        .btn-yellow { background: #ffcc00; color: #1d1d1f; }
        .btn-red { background: var(--danger); }
        .btn-green { background: #34c759; }
        .btn-gray { background: #8e8e93; }
        .btn-blue { background: #007aff; }

        #loadFile { display: none; }

        #readerContainer { 
            flex: 1; overflow-y: auto; padding: 40px 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }
        #paper { 
            width: 100%; max-width: 800px; background: var(--paper); padding: 70px; 
            height: auto; min-height: calc(100% - 80px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); border-radius: 12px; box-sizing: border-box; margin-bottom: 40px;
        }
        
        #setupBox { background: #f9f9fa; padding: 25px; border-radius: 10px; margin-bottom: 50px; border: 1px solid #e5e5ea; }
        #inputArea { width: 100%; height: 100px; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 14px; margin-bottom: 10px; outline: none; resize: vertical; background: #fff; box-sizing: border-box; }
        
        .novel-text { font-family: 'KoPub Batang', 'Batang', serif; font-size: 18px; line-height: 2.0; text-align: justify; color: #1d1d1f; word-break: keep-all; white-space: pre-wrap; }
        
        .episode-title { 
            font-size: 1.6em; font-weight: bold; margin-top: 80px; margin-bottom: 40px; 
            color: #1d1d1f; border-bottom: 2px solid #1d1d1f; padding-bottom: 15px; 
        }
        
        .episode-end { 
            text-align: center; margin: 60px 0; color: #aaa; font-size: 13px; 
            border-top: 2px dashed #eee; padding-top: 20px; 
        }

        #progressBarContainer { position: fixed; top: 62px; left: 0; width: 100%; height: 3px; background: transparent; z-index: 90; pointer-events: none; }
        #progressBar { height: 100%; background: #34c759; width: 0%; transition: width 0.3s; }
        .typing-loader { display: inline-block; color: #86868b; font-size: 13px; margin: 20px 0; }
        
        #saveStatus { font-size: 11px; font-weight: bold; margin-left: auto; padding: 4px 8px; border-radius: 4px; }
        .status-ok { color: #34c759; background: #e8faea; }
        .status-warn { color: #ff3b30; background: #ffe5e5; }
    </style>
</head>
<body>

<header>
    <div class="brand"><span>ğŸ“š</span> SmartTab</div>
    
    <input type="password" id="apiKeyInput" placeholder="API Key" autocomplete="new-password">
    <button class="btn-yellow" onclick="fetchModels()">1. ëª¨ë¸</button>
    <select id="modelSelect"><option>â—€ ê²€ìƒ‰</option></select>
    
    <div style="width:1px; height:20px; background:#e5e5ea; margin:0 5px;"></div>
    
    <input type="text" id="urlInput" placeholder="ì†Œì„¤ URL ì…ë ¥" value="https://kakuyomu.jp/works/4852201425154963487/episodes/4852201425154963490">
    <button onclick="openTab()" class="btn-blue">ğŸŒ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°</button>
    
    <div style="width:1px; height:20px; background:#e5e5ea; margin:0 5px;"></div>

    <input type="file" id="loadFile" accept=".html" onchange="importData(this)">
    <button onclick="document.getElementById('loadFile').click()" class="btn-gray" title="ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“‚</button>
    <button onclick="exportData()" class="btn-gray" title="ë°±ì—… ì €ì¥í•˜ê¸°">ğŸ’¾</button>
    
    <button onclick="printToPdf()" class="btn-green">ğŸ–¨ï¸ PDF</button>
    <button onclick="resetBook()" class="btn-red">ğŸ—‘ï¸</button>

    <div id="saveStatus" class="status-ok">ëŒ€ê¸°</div>
</header>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<div id="readerContainer">
    <div id="paper">
        <div id="setupBox">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3 style="margin:0; font-size:16px; color:#333;">ğŸ“‹ ë¹ ë¥¸ ì‹œì‘</h3>
                <span style="font-size:12px; color:#007aff; font-weight:bold;">ìƒˆ íƒ­ì—ì„œ ë¶ë§ˆí¬ë¥¼ ëˆ„ë¥´ë©´ ìë™ ë²ˆì—­ë©ë‹ˆë‹¤</span>
            </div>
            <input type="text" id="episodeTitle" placeholder="ì†Œì œëª© (ì˜ˆ: ì œ1í™”)" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #d2d2d7; border-radius:6px; box-sizing:border-box; font-weight:bold;">
            <textarea id="inputArea" placeholder="ìˆ˜ë™ìœ¼ë¡œ ë¶™ì—¬ë„£ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ì—..."></textarea>
            <button onclick="manualStart()" id="manualBtn" style="margin-top:10px; width:100%;">ìˆ˜ë™ ë²ˆì—­ ì‹œì‘</button>
            <button onclick="stopBatch()" id="stopBtn" class="btn-red" style="display:none; margin-top:10px; width:100%;">ì¤‘ì§€</button>
        </div>

        <div id="contentArea" class="novel-text">
            <div id="emptyMsg" style="text-align:center; color:#86868b; margin-top:50px;">
                <div style="font-size:40px; margin-bottom:20px; opacity:0.3;">ğŸš€</div>
                <b>ìŠ¤ë§ˆíŠ¸ íƒ­ ì—°ë™ ëŒ€ê¸° ì¤‘</b><br><br>
                1. ìƒë‹¨ì˜ <b>[ğŸŒ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°]</b> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.<br>
                2. ì—´ë¦° íƒ­ì—ì„œ <b>ë¶ë§ˆí¬ ë²„íŠ¼</b>ì„ ëˆ„ë¥´ì„¸ìš”.<br>
                3. íƒ­ì´ ë‹«íˆê³  ë²ˆì—­ì´ ì‹œì‘ë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
</div>

<script>
    const CHUNK_SIZE = 2500;
    const STORAGE_KEY = "gemini_smart_tab_book";
    let state = { chunks: [], currentIndex: 0, isTranslating: false };

    // --- ìŠ¤ë§ˆíŠ¸ ì—°ë™ (ì œëª© ìˆ˜ì •ë¨) ---
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'NOVEL_TEXT') {
            const text = event.data.text;
            if(!text) return;
            
            // ë³¸ë¬¸ ì±„ìš°ê¸°
            document.getElementById('inputArea').value = text;
            
            // ì œëª© ìë™ ìƒì„± (êµ°ë”ë”ê¸° ì—†ì´ ìˆ«ìë§Œ)
            const count = document.querySelectorAll('.episode-title').length + 1;
            document.getElementById('episodeTitle').value = `ì œ${count}í™”`; 

            // ë²ˆì—­ ì‹œì‘
            manualStart();
            updateStatus("âš¡ ë°ì´í„° ìˆ˜ì‹ ! ë²ˆì—­ ì‹œì‘", false);
        }
    });

    function openTab() {
        const url = document.getElementById('urlInput').value.trim();
        if(!url) return alert("URLì„ ì…ë ¥í•˜ì„¸ìš”.");
        window.open(url, '_blank');
    }

    // --- ê¸°ë³¸ ê¸°ëŠ¥ ---
    function updateStatus(msg, isError) {
        const el = document.getElementById('saveStatus');
        el.innerText = msg;
        el.className = isError ? 'status-warn' : 'status-ok';
    }

    window.onload = function() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved && saved.trim().length > 0) {
                document.getElementById('contentArea').innerHTML = saved;
                const msg = document.getElementById('emptyMsg');
                if(msg) msg.remove();
                updateStatus("âœ… ë³µêµ¬ë¨", false);
            }
        } catch(e) { updateStatus("âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ", true); }
    };

    function autoSave() {
        const content = document.getElementById('contentArea').innerHTML;
        try { localStorage.setItem(STORAGE_KEY, content); updateStatus("ğŸ’¾ ì €ì¥ë¨", false); } 
        catch(e) { updateStatus("âš ï¸ ì €ì¥ ë¶ˆê°€", true); }
    }

    function exportData() {
        const content = document.getElementById('contentArea').innerHTML;
        if(!content || content.includes("ìŠ¤ë§ˆíŠ¸ íƒ­")) return alert("ë‚´ìš© ì—†ìŒ");
        const blob = new Blob([`<!DOCTYPE html><html><body><div id="backup">${content}</div></body></html>`], {type: "text/html"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Backup_${new Date().toISOString().slice(0,10)}.html`;
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(e.target.result, "text/html");
            const backup = doc.getElementById('backup') || doc.getElementById('contentArea') || doc.body;
            document.getElementById('contentArea').innerHTML = backup.innerHTML;
            autoSave();
            alert("ë³µêµ¬ ì™„ë£Œ");
        };
        reader.readAsText(file);
    }

    function resetBook() {
        if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    async function fetchModels() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const select = document.getElementById('modelSelect');
        if(!key) return alert("í‚¤ ì…ë ¥ í•„ìš”");
        select.innerHTML = "<option>...</option>";
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            select.innerHTML = "";
            data.models.filter(m => m.name.includes("gemini") && m.supportedGenerationMethods.includes("generateContent"))
                .forEach(m => {
                    const opt = document.createElement("option");
                    opt.value = m.name.replace("models/", "");
                    opt.innerText = opt.value;
                    if(opt.value.includes("flash")) opt.selected = true;
                    select.appendChild(opt);
                });
            alert("âœ… ëª¨ë¸ ì¤€ë¹„ë¨");
        } catch(e) { alert("ì˜¤ë¥˜: "+e.message); select.innerHTML="<option>ì‹¤íŒ¨</option>"; }
    }

    function manualStart() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const model = document.getElementById('modelSelect').value;
        const text = document.getElementById('inputArea').value;
        const title = document.getElementById('episodeTitle').value;

        if(!key || model.includes("ê²€ìƒ‰")) return alert("1. ëª¨ë¸ ê²€ìƒ‰ í•„ìš”");
        if(!text.trim()) return alert("ë³¸ë¬¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

        const msg = document.getElementById('emptyMsg');
        if(msg) msg.remove();

        document.getElementById('manualBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        state.isTranslating = true;
        state.currentIndex = 0;

        const contentArea = document.getElementById('contentArea');
        const titleHtml = `<div class='episode-title page-break'>${title || 'ìƒˆ ì—í”¼ì†Œë“œ'}</div>`;
        const div = document.createElement("div");
        div.innerHTML = titleHtml;
        contentArea.appendChild(div);
        autoSave();

        const lines = text.split('\n');
        let temp = "", list = [];
        for(let line of lines) {
            if(temp.length + line.length > CHUNK_SIZE) { list.push(temp); temp = line + "\n"; }
            else { temp += line + "\n"; }
        }
        if(temp) list.push(temp);
        state.chunks = list;

        processQueue(key, model);
    }

    async function processQueue(key, model) {
        if (!state.isTranslating) return;
        if (state.currentIndex >= state.chunks.length) {
            finishBatch();
            return;
        }

        const chunk = state.chunks[state.currentIndex];
        const contentArea = document.getElementById('contentArea');
        const loader = document.createElement("div");
        loader.className = "typing-loader";
        loader.innerText = `âœ¨ ë²ˆì—­ ì¤‘... (${state.currentIndex + 1}/${state.chunks.length})`;
        contentArea.appendChild(loader);
        
        window.scrollTo(0, document.body.scrollHeight);
        document.getElementById('progressBar').style.width = `${((state.currentIndex)/state.chunks.length)*100}%`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: 
                    `ë‹¹ì‹ ì€ ë¬¸í•™ ì „ë¬¸ ë²ˆì—­ê°€ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”.\n[ì›ì¹™]\n1. ë¬¸í•™ì  ì™„ì„±ë„(ë¦¬ë“¬, ì •ì„œ)\n2. í™”ì í†¤ ìœ ì§€\n3. ì£¼ì„ ê¸ˆì§€\n\n${chunk}` 
                }] }] })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            
            loader.remove();
            const div = document.createElement("div");
            div.innerText = data.candidates[0].content.parts[0].text;
            div.style.marginBottom = "20px";
            contentArea.appendChild(div);
            
            autoSave();
            state.currentIndex++;
            if(state.isTranslating) setTimeout(() => processQueue(key, model), 1000);
        } catch(e) {
            loader.innerText = "ì˜¤ë¥˜ ì¬ì‹œë„...";
            setTimeout(() => processQueue(key, model), 3000);
        }
    }

    function finishBatch() {
        state.isTranslating = false;
        document.getElementById('progressBar').style.width = "0%";
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('manualBtn').style.display = 'inline-block';
        document.getElementById('inputArea').value = "";
        document.getElementById('episodeTitle').value = "";
        
        const endMarker = document.createElement("div");
        endMarker.className = "episode-end";
        endMarker.innerText = "âœ¨ ë²ˆì—­ ì™„ë£Œ âœ¨"; 
        document.getElementById('contentArea').appendChild(endMarker);
        
        window.scrollTo(0, document.body.scrollHeight);
        autoSave();
        alert("âœ… ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¤ìŒ í™”ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”.");
    }

    function stopBatch() {
        state.isTranslating = false;
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('manualBtn').style.display = 'inline-block';
        alert("ì¤‘ì§€ë¨");
    }

    function printToPdf() {
        if(document.getElementById('contentArea').innerText.length < 10) return alert("ë‚´ìš© ì—†ìŒ");
        window.print();
    }
</script>
</body>
</html>
