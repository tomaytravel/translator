<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Book Maker (Offline Check)</title>
    <style>
        :root { --bg: #f5f5f7; --paper: #fff; --text: #333; --primary: #007aff; --danger: #ff3b30; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        @media print {
            @page { size: A4; margin: 20mm; }
            body { background: white; height: auto; display: block; overflow: visible; }
            header, #setupBox, #progressBarContainer, ::-webkit-scrollbar { display: none !important; }
            #readerContainer { padding: 0; display: block; overflow: visible; height: auto; }
            #paper { box-shadow: none; width: 100%; max-width: 100%; padding: 0; margin: 0; border: none; min-height: 0; }
            .novel-text { font-size: 11pt; line-height: 1.8; color: black; text-align: justify; }
            .episode-title { page-break-before: always; }
        }

        header { 
            flex-shrink: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 12px 20px; border-bottom: 1px solid #ddd; 
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap; z-index: 1000;
        }
        .brand { font-weight: 800; font-size: 1.2rem; margin-right: 10px; color: #1d1d1f; }
        
        input, select { padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px; font-size: 13px; outline: none; }
        input:focus { border-color: var(--primary); }
        #apiKeyInput { width: 120px; }
        #modelSelect { width: 160px; background: #f2f2f7; color: #007aff; font-weight: 600; }

        button { padding: 8px 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; background: var(--primary); font-size: 13px; transition: 0.2s; white-space: nowrap; }
        button:hover { opacity: 0.9; }
        .btn-yellow { background: #ffcc00; color: #1d1d1f; }
        .btn-red { background: var(--danger); }
        .btn-green { background: #34c759; }
        .btn-gray { background: #8e8e93; }

        #loadFile { display: none; }

        #readerContainer { 
            flex: 1; overflow-y: auto; padding: 40px 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }
        #paper { 
            width: 100%; max-width: 800px; background: var(--paper); padding: 70px; 
            height: auto; min-height: calc(100% - 80px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); border-radius: 12px; box-sizing: border-box; margin-bottom: 40px;
        }
        
        #setupBox { background: #f9f9fa; padding: 25px; border-radius: 10px; margin-bottom: 50px; border: 1px solid #e5e5ea; }
        #inputArea { width: 100%; height: 100px; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; font-size: 14px; margin-bottom: 10px; outline: none; resize: vertical; background: #fff; box-sizing: border-box; }
        
        .novel-text { font-family: 'KoPub Batang', 'Batang', serif; font-size: 18px; line-height: 2.0; text-align: justify; color: #1d1d1f; word-break: keep-all; white-space: pre-wrap; }
        .episode-title { font-size: 1.6em; font-weight: bold; margin-top: 80px; margin-bottom: 40px; color: #1d1d1f; border-bottom: 2px solid #1d1d1f; padding-bottom: 15px; }

        #progressBarContainer { position: fixed; top: 62px; left: 0; width: 100%; height: 3px; background: transparent; z-index: 90; pointer-events: none; }
        #progressBar { height: 100%; background: #34c759; width: 0%; transition: width 0.3s; }
        .typing-loader { display: inline-block; color: #86868b; font-size: 13px; margin: 20px 0; }
        
        /* ìƒíƒœ í‘œì‹œë“± ìŠ¤íƒ€ì¼ */
        #saveStatus { font-size: 11px; font-weight: bold; margin-left: auto; padding: 4px 8px; border-radius: 4px; }
        .status-ok { color: #34c759; background: #e8faea; }
        .status-warn { color: #ff3b30; background: #ffe5e5; }
    </style>
</head>
<body>

<header>
    <div class="brand"><span>ğŸ“š</span> SafeBook</div>
    
    <input type="password" id="apiKeyInput" placeholder="API Key" autocomplete="new-password">
    <button class="btn-yellow" onclick="fetchModels()">1. ëª¨ë¸</button>
    <select id="modelSelect"><option>â—€ ê²€ìƒ‰</option></select>
    
    <div style="width:1px; height:20px; background:#e5e5ea; margin:0 5px;"></div>

    <button onclick="startTranslation()" id="startBtn">2. ë²ˆì—­ â–¶</button>
    <button onclick="stopBatch()" id="stopBtn" class="btn-red" style="display:none;">ì¤‘ì§€</button>
    
    <div style="width:1px; height:20px; background:#e5e5ea; margin:0 5px;"></div>

    <input type="file" id="loadFile" accept=".html" onchange="importData(this)">
    <button onclick="document.getElementById('loadFile').click()" class="btn-gray" title="ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ“‚ ë¡œë“œ</button>
    <button onclick="exportData()" class="btn-gray" title="ë°±ì—… ì €ì¥í•˜ê¸°">ğŸ’¾ ë°±ì—…</button>
    
    <button onclick="printToPdf()" class="btn-green">ğŸ–¨ï¸ PDF</button>
    <button onclick="resetBook()" class="btn-red">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>

    <div id="saveStatus" class="status-ok">ìƒíƒœ í™•ì¸ ì¤‘...</div>
</header>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<div id="readerContainer">
    <div id="paper">
        <div id="setupBox">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3 style="margin:0; font-size:16px; color:#333;">â• ì—í”¼ì†Œë“œ ì¶”ê°€</h3>
                <span style="font-size:12px; color:#666;">ë³µì‚¬í•œ ë³¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</span>
            </div>
            <input type="text" id="episodeTitle" placeholder="ì†Œì œëª© (ì˜ˆ: ì œ1í™”)" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #d2d2d7; border-radius:6px; box-sizing:border-box; font-weight:bold;">
            <textarea id="inputArea" placeholder="ë³¸ë¬¸ ë¶™ì—¬ë„£ê¸° (Ctrl+V)"></textarea>
        </div>

        <div id="contentArea" class="novel-text">
            <div id="emptyMsg" style="text-align:center; color:#86868b; margin-top:50px;">
                <div style="font-size:40px; margin-bottom:20px; opacity:0.3;">ğŸ“‚</div>
                <b>ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</b><br><br>
                1. í…ìŠ¤íŠ¸ë¥¼ ë„£ê³  ë²ˆì—­í•˜ë©´ ì €ì¥ë©ë‹ˆë‹¤.<br>
                2. ìš°ì¸¡ ìƒë‹¨ ìƒíƒœê°€ <b style="color:red">ë¹¨ê°„ìƒ‰</b>ì´ë©´ ë°˜ë“œì‹œ <b>[ğŸ’¾ ë°±ì—…]</b>ì„ ëˆ„ë¥´ì„¸ìš”.
            </div>
        </div>
    </div>
</div>

<script>
    const CHUNK_SIZE = 2500;
    const STORAGE_KEY = "gemini_safe_book_v2";
    let state = { chunks: [], currentIndex: 0, isTranslating: false };

    // --- 1. ì €ì¥ ì‹œìŠ¤í…œ (ì˜¤í”„ë¼ì¸ ê°ì§€ ê¸°ëŠ¥ ì¶”ê°€) ---
    function updateStatus(msg, isError) {
        const el = document.getElementById('saveStatus');
        el.innerText = msg;
        if(isError) {
            el.className = 'status-warn';
            el.title = "ì˜¤í”„ë¼ì¸ ëª¨ë“œì—ì„œëŠ” ìë™ ì €ì¥ì´ ì•ˆ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ [ë°±ì—…]í•˜ì„¸ìš”.";
        } else {
            el.className = 'status-ok';
            el.title = "ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
        }
    }

    // ì´ˆê¸° ë¡œë“œ ì‹œ í…ŒìŠ¤íŠ¸
    window.onload = function() {
        try {
            // ì €ì¥ì†Œ í…ŒìŠ¤íŠ¸
            localStorage.setItem("test_key", "ok");
            localStorage.removeItem("test_key");
            
            // ë°ì´í„° ë³µêµ¬ ì‹œë„
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved && saved.trim().length > 0) {
                document.getElementById('contentArea').innerHTML = saved;
                const msg = document.getElementById('emptyMsg');
                if(msg) msg.remove();
                updateStatus("âœ… ë³µêµ¬ ì™„ë£Œ", false);
            } else {
                updateStatus("âœ… ì €ì¥ ì¤€ë¹„ë¨", false);
            }
        } catch(e) {
            // ì˜¤í”„ë¼ì¸(file://) ë“±ì—ì„œ ì—ëŸ¬ ë°œìƒ ì‹œ
            console.error("Storage Error:", e);
            updateStatus("âš ï¸ ìë™ì €ì¥ ë¶ˆê°€ (ìˆ˜ë™ë°±ì—… ìš”ë§)", true);
        }
    };

    function autoSave() {
        const content = document.getElementById('contentArea').innerHTML;
        try {
            localStorage.setItem(STORAGE_KEY, content);
            updateStatus("ğŸ’¾ ì €ì¥ë¨ " + new Date().toLocaleTimeString(), false);
        } catch(e) {
            updateStatus("âš ï¸ ì €ì¥ ì‹¤íŒ¨! [ğŸ’¾ ë°±ì—…] ëˆ„ë¥´ì„¸ìš”", true);
        }
    }

    function exportData() {
        const content = document.getElementById('contentArea').innerHTML;
        if(!content || content.includes("ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤")) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

        const title = "ë²ˆì—­ë°±ì—…_" + new Date().toISOString().slice(0,10);
        const html = `<!DOCTYPE html><html lang="ko"><body><div id="backup-data">${content}</div></body></html>`;
        const blob = new Blob([html], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${title}.html`;
        link.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, "text/html");
            
            let newContent = "";
            const backupDiv = doc.getElementById('backup-data');
            const contentDiv = doc.getElementById('contentArea');

            if(backupDiv) newContent = backupDiv.innerHTML;
            else if(contentDiv) newContent = contentDiv.innerHTML;
            else newContent = doc.body.innerHTML;

            if(newContent) {
                document.getElementById('contentArea').innerHTML = newContent;
                autoSave(); // ë¶ˆëŸ¬ì˜¨ ë’¤ ì €ì¥ ì‹œë„
                alert("âœ… ë°ì´í„° ë³µêµ¬ ì™„ë£Œ!");
            } else {
                alert("âš ï¸ íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    function resetBook() {
        if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
            location.reload();
        }
    }

    // --- ë²ˆì—­ ë¡œì§ ---
    async function fetchModels() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const select = document.getElementById('modelSelect');
        if(!key) return alert("API í‚¤ ì…ë ¥ í•„ìš”");
        select.innerHTML = "<option>...</option>";
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            select.innerHTML = "";
            data.models.filter(m => m.name.includes("gemini") && m.supportedGenerationMethods.includes("generateContent"))
                .forEach(m => {
                    const opt = document.createElement("option");
                    opt.value = m.name.replace("models/", "");
                    opt.innerText = opt.value;
                    if(opt.value.includes("flash")) opt.selected = true;
                    select.appendChild(opt);
                });
            alert("âœ… ì¤€ë¹„ë¨");
        } catch(e) { alert("ì‹¤íŒ¨: "+e.message); select.innerHTML="<option>ì‹¤íŒ¨</option>"; }
    }

    function startTranslation() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const model = document.getElementById('modelSelect').value;
        const text = document.getElementById('inputArea').value;
        const title = document.getElementById('episodeTitle').value;

        if(!key || model.includes("ê²€ìƒ‰")) return alert("1. ëª¨ë¸ ê²€ìƒ‰ í•„ìš”");
        if(!text.trim()) return alert("ë³¸ë¬¸ ì…ë ¥ í•„ìš”");

        const msg = document.getElementById('emptyMsg');
        if(msg) msg.remove();

        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        state.isTranslating = true;
        state.currentIndex = 0;

        const contentArea = document.getElementById('contentArea');
        const titleHtml = `<div class='episode-title page-break'>${title || 'ìƒˆ ì—í”¼ì†Œë“œ'}</div>`;
        const div = document.createElement("div");
        div.innerHTML = titleHtml;
        contentArea.appendChild(div);
        autoSave();

        const lines = text.split('\n');
        let temp = "", list = [];
        for(let line of lines) {
            if(temp.length + line.length > CHUNK_SIZE) { list.push(temp); temp = line + "\n"; }
            else { temp += line + "\n"; }
        }
        if(temp) list.push(temp);
        state.chunks = list;

        processQueue(key, model);
    }

    async function processQueue(key, model) {
        if (!state.isTranslating) return;
        if (state.currentIndex >= state.chunks.length) {
            finishBatch();
            return;
        }

        const chunk = state.chunks[state.currentIndex];
        const contentArea = document.getElementById('contentArea');
        const loader = document.createElement("div");
        loader.className = "typing-loader";
        loader.innerText = `âœ¨ ë²ˆì—­ ì¤‘... (${state.currentIndex + 1}/${state.chunks.length})`;
        contentArea.appendChild(loader);
        
        window.scrollTo(0, document.body.scrollHeight);
        document.getElementById('progressBar').style.width = `${((state.currentIndex)/state.chunks.length)*100}%`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: 
                    `ë‹¹ì‹ ì€ ë¬¸í•™ ì „ë¬¸ ë²ˆì—­ê°€ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”.\n[ì›ì¹™]\n1. ë¬¸í•™ì  ì™„ì„±ë„(ë¦¬ë“¬, ì •ì„œ)\n2. í™”ì í†¤ ìœ ì§€\n3. ì£¼ì„ ê¸ˆì§€\n\n${chunk}` 
                }] }] })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            
            loader.remove();
            const div = document.createElement("div");
            div.innerText = data.candidates[0].content.parts[0].text;
            div.style.marginBottom = "20px";
            contentArea.appendChild(div);
            
            autoSave();

            state.currentIndex++;
            if(state.isTranslating) setTimeout(() => processQueue(key, model), 1000);
        } catch(e) {
            loader.innerText = "ì˜¤ë¥˜ ì¬ì‹œë„...";
            setTimeout(() => processQueue(key, model), 3000);
        }
    }

    function finishBatch() {
        state.isTranslating = false;
        document.getElementById('progressBar').style.width = "0%";
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('inputArea').value = "";
        document.getElementById('episodeTitle').value = "";
        alert("ì™„ë£Œ!");
    }

    function stopBatch() {
        state.isTranslating = false;
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('startBtn').style.display = 'inline-block';
        alert("ì¤‘ì§€ë¨");
    }

    function printToPdf() {
        if(document.getElementById('contentArea').innerText.trim().length < 10) return alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        window.print();
    }
</script>
</body>
</html>
