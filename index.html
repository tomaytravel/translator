<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Universal Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <style>
        :root { --bg: #fdfbf7; --paper: #fff; --text: #2b2b2b; --primary: #1a73e8; }
        body { margin: 0; padding: 0; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { 
            background: #fff; padding: 12px 20px; border-bottom: 1px solid #e0e0e0; 
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.03); z-index: 100;
        }
        .brand { font-weight: 900; color: #444; font-size: 1.1rem; margin-right: 10px; display: flex; align-items: center; gap: 5px; }
        .brand span { color: var(--primary); font-size: 1.3rem; }

        /* ì…ë ¥ ì»¨íŠ¸ë¡¤ ê³µí†µ */
        input, select { padding: 9px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; outline: none; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(26,115,232,0.1); }
        
        #apiKeyInput { width: 140px; }
        #modelSelect { width: 180px; background: #e8f0fe; font-weight: bold; color: #1557b0; }
        
        /* ëª¨ë“œ ìŠ¤ìœ„ì¹˜ */
        .mode-switch { display: flex; background: #f1f3f4; border-radius: 6px; padding: 3px; }
        .mode-btn { border: none; background: transparent; padding: 6px 12px; cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 4px; color: #5f6368; transition: 0.2s; }
        .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* ì…ë ¥ ê·¸ë£¹ */
        .input-group { display: none; flex-grow: 1; gap: 5px; }
        .input-group.active { display: flex; }
        #urlInput { width: 100%; }
        #fileInput { font-size: 13px; padding: 6px; }

        /* ë²„íŠ¼ */
        button { padding: 9px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; background: var(--primary); font-size: 13px; transition: 0.2s; white-space: nowrap; }
        button:hover { filter: brightness(0.9); }
        button:disabled { background: #dadce0; cursor: default; filter: none; }
        
        .btn-yellow { background: #fbbc04; color: #333; }
        .btn-stop { background: #ea4335; }
        .btn-save { background: #34a853; }

        /* ë©”ì¸ ì˜ì—­ */
        #readerContainer { flex: 1; overflow-y: auto; padding: 40px 20px; display: flex; justify-content: center; scroll-behavior: smooth; }
        #paper { width: 100%; max-width: 800px; background: var(--paper); padding: 80px; min-height: 100%; box-shadow: 0 4px 25px rgba(0,0,0,0.05); border-radius: 4px; }

        .novel-text { font-family: 'KoPub Batang', 'Batang', serif; font-size: 18px; line-height: 2.0; text-align: justify; color: #2b2b2b; word-break: keep-all; white-space: pre-wrap; }
        
        /* êµ¬ë¶„ì„  */
        .page-divider { text-align: center; margin: 60px 0; color: #ccc; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .page-divider::before, .page-divider::after { content: ""; height: 1px; background: #eee; width: 100px; display: block; }

        /* ì§„í–‰ë°” */
        #progressBarContainer { position: fixed; top: 61px; left: 0; width: 100%; height: 3px; background: transparent; z-index: 99; pointer-events: none; }
        #progressBar { height: 100%; background: #34a853; width: 0%; transition: width 0.3s; }
        
        /* ë¡œë” */
        .typing-loader { display: block; text-align: center; margin: 40px 0; color: #888; font-size: 14px; font-style: italic; }
        .dots::after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body>

<header>
    <div class="brand"><span>ğŸ“š</span> Reader</div>
    
    <input type="password" id="apiKeyInput" placeholder="API Key" autocomplete="new-password">
    <button class="btn-yellow" onclick="fetchModels()">1. ëª¨ë¸ ê²€ìƒ‰</button>
    <select id="modelSelect"><option>â—€ ê²€ìƒ‰ í•„ìš”</option></select>
    
    <div style="width:1px; height:20px; background:#e0e0e0; margin:0 10px;"></div>

    <div class="mode-switch">
        <button class="mode-btn active" onclick="setMode('web')" id="btnWeb">Web</button>
        <button class="mode-btn" onclick="setMode('pdf')" id="btnPdf">PDF</button>
    </div>

    <div class="input-group active" id="groupWeb">
        <input type="text" id="urlInput" placeholder="https://..." value="">
    </div>
    <div class="input-group" id="groupPdf">
        <input type="file" id="fileInput" accept="application/pdf">
    </div>

    <button onclick="startBatch()" id="startBtn">2. ë²ˆì—­ ì‹œì‘</button>
    <button onclick="stopBatch()" id="stopBtn" class="btn-stop" style="display:none;">ì¤‘ì§€</button>
    <button onclick="saveToFile()" id="saveBtn" class="btn-save" style="display:none;">ğŸ’¾ ì €ì¥</button>
</header>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<div id="readerContainer">
    <div id="paper" class="novel-text">
        <div style="text-align:center; color:#999; margin-top:120px;">
            <div style="font-size:3rem; margin-bottom:20px; opacity:0.3;">ğŸ“–</div>
            <h3 style="color:#555;">ë¬¸í•™ ë²ˆì—­ ë¦¬ë”ê¸°</h3>
            <p>
                API í‚¤ ì…ë ¥ í›„ ëª¨ë¸ì„ ê²€ìƒ‰í•˜ê³ ,<br>
                ì›¹ì†Œì„¤ URLì´ë‚˜ PDF íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ë²ˆì—­ì„ ì‹œì‘í•˜ì„¸ìš”.
            </p>
        </div>
    </div>
</div>

<script>
    const PROXY = "https://corsproxy.io/?"; 
    const CHUNK_SIZE = 2000;
    
    let state = {
        mode: 'web', 
        chunks: [],
        currentIndex: 0,
        isTranslating: false,
        fullText: ""
    };

    function setMode(mode) {
        state.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.input-group').forEach(g => g.classList.remove('active'));
        
        if(mode === 'web') {
            document.getElementById('btnWeb').classList.add('active');
            document.getElementById('groupWeb').classList.add('active');
        } else {
            document.getElementById('btnPdf').classList.add('active');
            document.getElementById('groupPdf').classList.add('active');
        }
    }

    async function fetchModels() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const select = document.getElementById('modelSelect');
        if(!key) return alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        select.innerHTML = "<option>ì¡°íšŒ ì¤‘...</option>";
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            
            select.innerHTML = "";
            // Gemini ëª¨ë¸ ì¤‘ generateContent ì§€ì›í•˜ëŠ” ê²ƒë§Œ í•„í„°ë§
            const valid = data.models.filter(m => m.name.includes("gemini") && m.supportedGenerationMethods.includes("generateContent"));
            
            if(valid.length === 0) throw new Error("ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.");

            valid.forEach(m => {
                const name = m.name.replace("models/", "");
                const opt = document.createElement("option");
                opt.value = name; opt.innerText = name;
                if(name.includes("flash") && name.includes("exp")) opt.selected = true; // ìµœì‹  ì‹¤í—˜ì  ëª¨ë¸ ìš°ì„ 
                else if(name.includes("flash")) opt.selected = true;
                select.appendChild(opt);
            });
            alert(`âœ… ${valid.length}ê°œì˜ ëª¨ë¸ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
        } catch(e) { alert("ëª¨ë¸ ì¡°íšŒ ì‹¤íŒ¨: "+e.message); select.innerHTML="<option>ì‹¤íŒ¨</option>"; }
    }

    async function startBatch() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const model = document.getElementById('modelSelect').value;
        const paper = document.getElementById('paper');

        if(!key || model.includes("ê²€ìƒ‰")) return alert("ë¨¼ì € [1. ëª¨ë¸ ê²€ìƒ‰]ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.");

        // UI ìƒíƒœ ë³€ê²½
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('saveBtn').style.display = 'none';
        
        state.isTranslating = true;
        state.currentIndex = 0;
        state.fullText = "";
        state.chunks = [];
        paper.innerHTML = ""; // í™”ë©´ ì´ˆê¸°í™”

        appendLog("ë°ì´í„° ë¶„ì„ ì¤‘...");

        try {
            let fullContent = "";

            if (state.mode === 'web') {
                const url = document.getElementById('urlInput').value.trim();
                if(!url) throw new Error("URLì„ ì…ë ¥í•˜ì„¸ìš”.");
                
                const res = await fetch(PROXY + encodeURIComponent(url));
                const text = await res.text();
                
                if(text.includes("<html") || text.includes("<div")) {
                    const doc = new DOMParser().parseFromString(text, "text/html");
                    const targets = ['.widget-episodeBody', '#novel_honbun', '.p-novel__body', 'div.entry-content', 'body'];
                    for(let t of targets) {
                        const el = doc.querySelector(t);
                        if(el) { fullContent = el.innerText; break; }
                    }
                    if(!fullContent) fullContent = doc.body.innerText;
                } else { fullContent = text; }

            } else {
                const fileInput = document.getElementById('fileInput');
                if(fileInput.files.length === 0) throw new Error("PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
                
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                appendLog(`PDF ë¶„ì„ ì¤‘: ${file.name}`);
                
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullContent += textContent.items.map(item => item.str).join(' ') + "\n\n";
                }
            }

            // í…ìŠ¤íŠ¸ ë¶„í• 
            const lines = fullContent.split('\n');
            let temp = "", list = [];
            for(let line of lines) {
                if(temp.length + line.length > CHUNK_SIZE) { list.push(temp); temp = line + "\n"; }
                else { temp += line + "\n"; }
            }
            if(temp) list.push(temp);
            state.chunks = list;

            paper.innerHTML = ""; // ë¡œê·¸ ì‚­ì œ
            processQueue(key, model);

        } catch(e) {
            alert("ì¤€ë¹„ ì‹¤íŒ¨: " + e.message);
            stopBatch();
        }
    }

    async function processQueue(key, model) {
        if (!state.isTranslating) return;
        if (state.currentIndex >= state.chunks.length) {
            finishBatch();
            return;
        }

        const chunk = state.chunks[state.currentIndex];
        const paper = document.getElementById('paper');

        const loaderDiv = document.createElement("div");
        loaderDiv.className = "typing-loader dots";
        loaderDiv.innerText = `ë²ˆì—­ ì¤‘... (${state.currentIndex + 1}/${state.chunks.length})`;
        paper.appendChild(loaderDiv);
        
        // ìë™ ìŠ¤í¬ë¡¤
        window.scrollTo(0, document.body.scrollHeight);
        
        // ì§„í–‰ë¥  í‘œì‹œ
        const progress = ((state.currentIndex) / state.chunks.length) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;

        try {
            const prompt = `
            ë‹¹ì‹ ì€ ë¬¸í•™ ì „ë¬¸ ë²ˆì—­ê°€ì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”.
            [ì›ì¹™]
            1. ë¬¸í•™ì  ì™„ì„±ë„ (ë¦¬ë“¬, í˜¸í¡, ì •ì„œ ìœ ì§€)
            2. í™”ìì˜ í†¤ ìœ ì§€ (í•˜ë“œë³´ì¼ë“œ/ì„œì •ì„± ë“±)
            3. PDF ë“±ì—ì„œ ë°œìƒí•œ ëŠê¸´ ë¬¸ì¥ì€ ìì—°ìŠ¤ëŸ½ê²Œ ì´ìœ¼ì‹­ì‹œì˜¤.
            4. ì£¼ì„ ê¸ˆì§€, ì˜¤ì§ ë²ˆì—­ë¬¸ë§Œ ì¶œë ¥
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt + "\n\n" + chunk }] }]
                })
            });
            
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            
            const translatedText = data.candidates[0].content.parts[0].text;

            loaderDiv.remove();
            appendTranslation(translatedText, state.currentIndex + 1);

            state.currentIndex++;
            // ì†ë„ ì¡°ì ˆ (1.5ì´ˆ ëŒ€ê¸°)
            if(state.isTranslating) setTimeout(() => processQueue(key, model), 1500);

        } catch(e) {
            loaderDiv.innerText = `âš ï¸ ì˜¤ë¥˜: ${e.message}. ì¬ì‹œë„ ì¤‘...`;
            setTimeout(() => processQueue(key, model), 3000);
        }
    }

    function appendTranslation(text, pageNum) {
        const paper = document.getElementById('paper');
        const div = document.createElement("div");
        div.innerText = text;
        div.style.marginBottom = "30px";
        
        const divider = document.createElement("div");
        divider.className = "page-divider";
        divider.innerText = `Page ${pageNum}`;

        paper.appendChild(div);
        paper.appendChild(divider);

        state.fullText += `<div class='page-content'>${text.replace(/\n/g, "<br>")}</div><hr class='divider' data-content='Page ${pageNum}'>`;
    }

    function appendLog(msg) {
        const paper = document.getElementById('paper');
        const p = document.createElement("p");
        p.style.textAlign = "center";
        p.style.color = "#888";
        p.innerText = msg;
        paper.appendChild(p);
    }

    function stopBatch() {
        state.isTranslating = false;
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'inline-block';
        alert("ë²ˆì—­ì„ ë©ˆì·„ìŠµë‹ˆë‹¤.");
    }

    function finishBatch() {
        state.isTranslating = false;
        document.getElementById('progressBar').style.width = "100%";
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'inline-block';
        
        const paper = document.getElementById('paper');
        const endMsg = document.createElement("div");
        endMsg.style.textAlign = "center";
        endMsg.style.margin = "60px 0";
        endMsg.style.color = "#188038";
        endMsg.innerHTML = "<h3>ğŸ‰ ì™„ë…!</h3><p>ì´ì œ ì €ì¥í•˜ì—¬ ì†Œì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>";
        paper.appendChild(endMsg);
        window.scrollTo(0, document.body.scrollHeight);
    }

    function saveToFile() {
        if(!state.fullText) return alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
        const title = "ë²ˆì—­_" + new Date().toISOString().slice(0,10);
        const htmlContent = `
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8"><title>${title}</title>
            <style>
                body { background: #fdfbf7; padding: 20px; font-family: 'Pretendard', sans-serif; line-height: 2.0; color: #2b2b2b; }
                .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 60px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border-radius: 4px; }
                .page-content { font-family: 'KoPub Batang', 'Batang', serif; font-size: 18px; text-align: justify; word-break: keep-all; margin-bottom: 30px; }
                .divider { border: 0; border-top: 1px solid #eee; margin: 50px 0; text-align: center; color: #ccc; font-size: 12px; }
            </style>
        </head>
        <body><div class="container"><h1>${title}</h1><br>${state.fullText}</div></body></html>`;
        
        const blob = new Blob([htmlContent], { type: "text/html" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${title}.html`;
        link.click();
    }
</script>
</body>
</html>